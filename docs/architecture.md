# Vogix Architecture

## 1. Overview

Vogix is a runtime theme management system for NixOS with multi-scheme support. This document provides a high-level overview of the architecture that enables dynamic theme switching at runtime.

The system supports 4 color schemes (vogix16, base16, base24, ansi16), allowing users to switch themes without requiring a rebuild.

## 2. Key Components

### Build Time (Nix/home-manager)
- **Theme Sources**:
  - Native vogix16 themes from [vogix16-themes](https://github.com/i-am-logger/vogix16-themes) repo
  - Imported base16/base24 from [tinted-schemes](https://github.com/i-am-logger/tinted-schemes)
  - Imported ansi16 from [iTerm2-Color-Schemes](https://github.com/i-am-logger/iTerm2-Color-Schemes)
- **Application Generators**: Nix functions in `nix/modules/applications/` supporting all 4 schemes
- **Theme Generation**: All scheme-theme-variant configs pre-generated and stored in `/nix/store`
- **XDG Directories**: home-manager creates theme packages in `~/.local/share/vogix/themes/`

### Runtime (vogix CLI)
- **Symlink Management**: Updates `current-theme` symlink to switch between pre-generated configs
- **State Persistence**: Tracks current scheme/theme/variant selection
- **Variant Navigation**: Supports `darker`/`lighter` navigation through polarity-ordered variants
- **Reload Mechanism**: Notifies applications to reload their configurations

For detailed implementation of specific components, see the specialized documentation:
- [CLI Tool Documentation](cli.md)
- [Reload Mechanism](reload.md)
- [Theme Format and Structure](theming.md)

## 3. Directory Structure

```
/nix/store/xxxx-vogix-base16-catppuccin-mocha/  # Pre-generated theme configs (immutable)
    ├── alacritty/alacritty.toml
    ├── btop/btop.conf
    └── console/palette

/etc/vogix/config.toml                         # System config (NixOS module)

~/.local/share/vogix/themes/                   # Theme packages (home-manager)
    ├── base16-catppuccin-mocha -> /nix/store/...
    ├── base16-catppuccin-latte -> /nix/store/...
    ├── vogix16-aikido-dark -> /nix/store/...
    └── ...

~/.local/state/vogix/                          # CLI managed (mutable)
    ├── state.toml                             # Current scheme/theme/variant
    └── current-theme -> ~/.local/share/vogix/themes/base16-catppuccin-mocha

~/.config/                                     # App config symlinks
    ├── alacritty/alacritty.toml -> ~/.local/state/vogix/current-theme/alacritty/alacritty.toml
    ├── btop/btop.conf -> ~/.local/state/vogix/current-theme/btop/btop.conf
    └── ... (non-themed apps managed normally by home-manager)
```

**Critical Architecture Points:**
1. Theme configs are **generated by Nix** at build time, stored in immutable `/nix/store`
2. `~/.local/share/vogix/themes/` contains symlinks to theme packages in `/nix/store`
3. `~/.local/state/vogix/current-theme` symlink is the **only thing vogix CLI modifies**
4. App configs in `~/.config/` point to `current-theme/`, enabling instant switching

## 4. Home-Manager Integration

The home-manager module (`programs.vogix`) handles all build-time generation:

1. **Theme Discovery**: 
   - Native vogix16 themes from [vogix16-themes](https://github.com/i-am-logger/vogix16-themes) repo
   - Imported base16/base24 from tinted-schemes fork
   - Imported ansi16 from iTerm2-Color-Schemes fork
2. **Application Discovery**: Auto-discovers generators from `nix/modules/applications/*.nix`
3. **Config Generation**: For each (scheme, theme, variant, app) combination, generates configs
4. **XDG Directories**: Creates theme packages in `~/.local/share/vogix/themes/` via xdg.dataFile
5. **Auto-Theming**: Automatically themes apps where `programs.<app>.enable = true`

```nix
# Example home-manager configuration
{
  # Enable applications you want themed
  programs.alacritty.enable = true;
  programs.btop.enable = true;

  # Configure vogix
  programs.vogix = {
    enable = true;
    scheme = "vogix16";
    theme = "aikido";
    variant = "dark";
  };
}
```

**Build Process:**
1. Nix evaluates theme definitions and application generators
2. Generates all scheme-theme-variant combinations
3. Stores generated configs in `/nix/store/xxxx-vogix-{scheme}-{theme}-{variant}/`
4. Systemd service creates symlinks on user login

## 5. Theme Switching Mechanism

When a user runs `vogix -t catppuccin -v mocha` or `vogix -v darker`:

1. **Validate**: Verify the requested scheme-theme-variant exists in `~/.local/share/vogix/themes/`
2. **Update Symlink**: Change `~/.local/state/vogix/current-theme` symlink to point to new theme
3. **Persist State**: Save selection to `~/.local/state/vogix/state.toml`
4. **Reload Apps**: Trigger application reloads per config
5. **Instant Effect**: Since `~/.config/` points to `current-theme/`, change is immediate

**Key Advantage**: No config generation at runtime. All theme files pre-exist in `/nix/store`, making switching instant.

## 6. Implementation Details

### Build-Time Components (Nix)
1. **home-manager module** (`nix/modules/home-manager/`): Split into default.nix, generators.nix, options.nix, themes.nix
2. **Shared libraries** (`nix/modules/lib/`): applications.nix, colors.nix, vogix16.nix
3. **base16-import.nix**: Imports YAML themes from tinted-schemes fork
4. **ansi16-import.nix**: Imports TOML themes from iTerm2-Color-Schemes fork
5. **vogix16-import.nix**: Imports TOML themes from vogix16-themes repo
6. **Application Generators** (`nix/modules/applications/`): Multi-scheme generators

### Runtime Components (Rust)
1. **Commands** (`src/commands/`): cache, completions, list, refresh, status, theme_change
2. **Theme Management** (`src/theme/`): discovery, loader (per-scheme), query, types
3. **Template Rendering** (`src/template/`): Tera-based config rendering
4. **Cache** (`src/cache/`): Theme cache paths and rendering
5. **Core modules**: cli.rs, config/, errors.rs, reload.rs, scheme.rs, state.rs, symlink.rs
