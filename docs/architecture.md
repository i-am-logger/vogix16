# Vogix Architecture

## 1. Overview

Vogix is a runtime theme management system for NixOS with multi-scheme support. This document provides a high-level overview of the architecture that enables dynamic theme switching at runtime.

The system supports 4 color schemes (vogix16, base16, base24, ansi16), allowing users to switch themes without requiring a rebuild.

## 2. Key Components

### Build Time (Nix/home-manager)
- **Theme Sources**:
  - Native themes in `themes/vogix16/*.nix`
  - Imported base16/base24 from [tinted-schemes](https://github.com/i-am-logger/tinted-schemes)
  - Imported ansi16 from [iTerm2-Color-Schemes](https://github.com/i-am-logger/iTerm2-Color-Schemes)
- **Application Generators**: Nix functions in `nix/modules/applications/` supporting all 4 schemes
- **Theme Generation**: All scheme-theme-variant configs pre-generated and stored in `/nix/store`
- **Systemd Service**: `vogix-setup` creates symlinks from `/nix/store` to runtime directories

### Runtime (vogix CLI)
- **Symlink Management**: Updates `current-theme` symlink to switch between pre-generated configs
- **State Persistence**: Tracks current scheme/theme/variant selection
- **Variant Navigation**: Supports `darker`/`lighter` navigation through polarity-ordered variants
- **Reload Mechanism**: Notifies applications to reload their configurations

For detailed implementation of specific components, see the specialized documentation:
- [CLI Tool Documentation](cli.md)
- [Reload Mechanism](reload.md)
- [Theme Format and Structure](theming.md)

## 3. Directory Structure

```
/nix/store/xxxx-vogix-base16-catppuccin-mocha/  # Pre-generated theme configs (immutable)
    ├── alacritty/colors.toml
    ├── btop/themes/vogix.theme
    └── console/palette

/run/user/1000/vogix/
    ├── themes/                              # Symlinks to /nix/store theme packages
    │   ├── base16-catppuccin-mocha -> /nix/store/...
    │   ├── base16-catppuccin-latte -> /nix/store/...
    │   ├── vogix16-aikido-dark -> /nix/store/...
    │   ├── ansi16-dracula-dracula -> /nix/store/...
    │   ├── current-theme -> base16-catppuccin-mocha  # Managed by vogix CLI
    │   └── ...
    ├── manifest.toml                        # Generated by systemd service
    └── state/                               # vogix CLI state directory
        └── state.toml

~/.config/                                   # User configuration directory
    ├── alacritty/colors.toml -> /run/user/1000/vogix/themes/current-theme/alacritty/colors.toml
    ├── btop/themes/vogix.theme -> /run/user/1000/vogix/themes/current-theme/btop/themes/vogix.theme
    └── ... (non-themed apps managed normally by home-manager)
```

**Critical Architecture Points:**
1. Theme configs are **generated by Nix** at build time, stored in immutable `/nix/store`
2. `/run/user/UID/vogix/themes/` contains symlinks to theme packages in `/nix/store`
3. `current-theme` symlink is the **only thing vogix CLI modifies**
4. App configs in `~/.config/` point to `current-theme/`, enabling instant switching

## 4. Home-Manager Integration

The home-manager module (`programs.vogix`) handles all build-time generation:

1. **Theme Discovery**: 
   - Native vogix16 themes from `themes/vogix16/*.nix`
   - Imported base16/base24 from tinted-schemes fork
   - Imported ansi16 from iTerm2-Color-Schemes fork
2. **Application Discovery**: Auto-discovers generators from `nix/modules/applications/*.nix`
3. **Config Generation**: For each (scheme, theme, variant, app) combination, generates configs
4. **Systemd Setup**: Creates `vogix-setup.service` to initialize runtime directories and symlinks
5. **Auto-Theming**: Automatically themes apps where `programs.<app>.enable = true`

```nix
# Example home-manager configuration
{
  # Enable applications you want themed
  programs.alacritty.enable = true;
  programs.btop.enable = true;

  # Configure vogix
  programs.vogix = {
    enable = true;
    defaultScheme = "vogix16";
    defaultTheme = "aikido";
    defaultVariant = "dark";
  };
}
```

**Build Process:**
1. Nix evaluates theme definitions and application generators
2. Generates all scheme-theme-variant combinations
3. Stores generated configs in `/nix/store/xxxx-vogix-{scheme}-{theme}-{variant}/`
4. Systemd service creates symlinks on user login

## 5. Theme Switching Mechanism

When a user runs `vogix -t catppuccin -v mocha` or `vogix -v darker`:

1. **Validate**: Verify the requested scheme-theme-variant exists in `/run/user/UID/vogix/themes/`
2. **Update Symlink**: Change `current-theme` symlink to point to new theme (e.g., `base16-catppuccin-mocha`)
3. **Persist State**: Save selection to `/run/user/UID/vogix/state/state.toml`
4. **Reload Apps**: Trigger application reloads per `manifest.toml` configuration
5. **Instant Effect**: Since `~/.config/` points to `current-theme/`, change is immediate

**Key Advantage**: No config generation at runtime. All theme files pre-exist in `/nix/store`, making switching instant.

## 6. Implementation Details

### Build-Time Components (Nix)
1. **home-manager.nix**: Module definition, theme discovery, config generation
2. **base16-import.nix**: Imports YAML themes from tinted-schemes fork
3. **ansi16-import.nix**: Imports TOML themes from iTerm2-Color-Schemes fork
4. **Application Generators** (`nix/modules/applications/`): Multi-scheme generators
5. **Theme Definitions** (`themes/vogix16/*.nix`): Native vogix16 themes
6. **Systemd Service**: `vogix-setup` runs at login to create directory structure

### Runtime Components (Rust)
1. **vogix CLI**:
   - `cli.rs`: Command parsing with `-s`, `-t`, `-v` flags
   - `scheme.rs`: Scheme enum (Vogix16, Base16, Base24, Ansi16) (vogix16 is the default scheme)
   - `symlink.rs`: Manages `current-theme` symlink
   - `state.rs`: Persists scheme/theme/variant selection
   - `theme.rs`: Discovers available themes, variant ordering by luminance
   - `reload.rs`: Triggers app reloads
2. **No template processing**: All configs pre-generated by Nix
