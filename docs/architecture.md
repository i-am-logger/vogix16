# Vogix16 Architecture

## 1. Overview

Vogix16 is a minimalist design system focused on functional color usage in NixOS. This document provides a high-level overview of the architecture that enables dynamic theme switching at runtime.

The system is designed to allow users to switch between themes (color palettes) and variants (dark/light) without requiring a rebuild, making the theming experience seamless.

## 2. Key Components

### Build Time (Nix/home-manager)
- **Theme Definitions**: 19 theme files in `themes/*.nix` defining color palettes in the Vogix16 format
- **Application Generators**: Nix functions in `nix/modules/applications/` that generate themed configs
- **Theme Generation**: All theme-variant configs pre-generated and stored in `/nix/store`
- **Systemd Service**: `vogix16-setup` creates symlinks from `/nix/store` to runtime directories

### Runtime (vogix CLI)
- **Symlink Management**: Updates `current-theme` symlink to switch between pre-generated configs
- **State Persistence**: Tracks current theme/variant selection
- **Reload Mechanism**: Notifies applications to reload their configurations

For detailed implementation of specific components, see the specialized documentation:
- [CLI Tool Documentation](cli.md)
- [Reload Mechanism](reload.md)
- [Theme Format and Structure](theming.md)

## 3. Directory Structure

```
/nix/store/xxxx-vogix16-theme-aikido-dark/  # Pre-generated theme configs (immutable)
    ├── alacritty/colors.toml
    ├── btop/themes/vogix.theme
    └── console/palette

/run/user/1000/vogix16/
    ├── themes/                              # Symlinks to /nix/store theme packages
    │   ├── aikido-dark -> /nix/store/...
    │   ├── aikido-light -> /nix/store/...
    │   ├── forest-dark -> /nix/store/...
    │   ├── forest-light -> /nix/store/...
    │   ├── current-theme -> aikido-dark     # Managed by vogix CLI
    │   └── ...
    ├── manifest.toml                        # Generated by systemd service
    └── state/                               # vogix CLI state directory
        └── state.toml

~/.config/                                   # User configuration directory
    ├── alacritty/colors.toml -> /run/user/1000/vogix16/themes/current-theme/alacritty/colors.toml
    ├── btop/themes/vogix.theme -> /run/user/1000/vogix16/themes/current-theme/btop/themes/vogix.theme
    └── ... (non-themed apps managed normally by home-manager)
```

**Critical Architecture Points:**
1. Theme configs are **generated by Nix** at build time, stored in immutable `/nix/store`
2. `/run/user/UID/vogix16/themes/` contains symlinks to theme packages in `/nix/store`
3. `current-theme` symlink is the **only thing vogix CLI modifies**
4. App configs in `~/.config/` point to `current-theme/`, enabling instant switching

## 4. Home-Manager Integration

The home-manager module (`programs.vogix16`) handles all build-time generation:

1. **Theme Discovery**: Auto-discovers all themes from `themes/*.nix`
2. **Application Discovery**: Auto-discovers generators from `nix/modules/applications/*.nix`
3. **Config Generation**: For each theme-variant pair, generates configs for all enabled apps
4. **Systemd Setup**: Creates `vogix16-setup.service` to initialize runtime directories and symlinks
5. **Auto-Theming**: Automatically themes apps where `programs.<app>.enable = true`

```nix
# Example home-manager configuration
{
  # Enable applications you want themed
  programs.alacritty.enable = true;
  programs.btop.enable = true;

  # Configure vogix16
  programs.vogix16 = {
    enable = true;
    defaultTheme = "aikido";
    defaultVariant = "dark";

    # Optional per-app overrides
    alacritty.theme = "forest";    # Use different theme for this app
    btop.variant = "light";         # Use different variant for this app
  };
}
```

**Build Process:**
1. Nix evaluates theme definitions and application generators
2. Generates all theme-variant combinations (19 themes × 2 variants = 38 packages)
3. Stores generated configs in `/nix/store/xxxx-vogix16-theme-{name}-{variant}/`
4. Systemd service creates symlinks on user login

## 5. Theme Switching Mechanism

When a user runs `vogix switch` or `vogix theme <name>`:

1. **Validate**: Verify the requested theme-variant exists in `/run/user/UID/vogix16/themes/`
2. **Update Symlink**: Change `current-theme` symlink to point to new theme-variant (e.g., `aikido-dark` → `forest-light`)
3. **Persist State**: Save selection to `/run/user/UID/vogix16/state/state.toml`
4. **Reload Apps**: Trigger application reloads per `manifest.toml` configuration
5. **Instant Effect**: Since `~/.config/` points to `current-theme/`, change is immediate

**Key Advantage**: No config generation at runtime. All theme files pre-exist in `/nix/store`, making switching instant.

## 6. Implementation Details

### Build-Time Components (Nix)
1. **home-manager.nix** (496 lines): Module definition, theme discovery, config generation
2. **Application Generators** (`nix/modules/applications/`): Nix functions that generate themed configs
3. **Theme Definitions** (`themes/*.nix`): 19 themes with dark/light variants
4. **Systemd Service**: `vogix16-setup` runs at login to create directory structure

### Runtime Components (Rust)
1. **vogix CLI** (876 lines total):
   - `cli.rs`: Command parsing
   - `symlink.rs`: Manages `current-theme` symlink
   - `state.rs`: Persists theme/variant selection
   - `theme.rs`: Discovers available themes
   - `reload.rs`: Triggers app reloads
   - `generator.rs`: Validates theme-variant exists
2. **No template processing**: All configs pre-generated by Nix

