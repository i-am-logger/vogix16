#!/usr/bin/env bash
export DIRENV_WARN_TIMEOUT=20s

# Bootstrap devenv if it's not already available.
if ! command -v devenv >/dev/null 2>&1; then
  if ! command -v nix >/dev/null 2>&1; then
    echo "error: devenv not found, and nix is not installed. Install Nix or provide devenv on PATH." >&2
    exit 1
  fi

  mkdir -p .direnv

  # Cache the built devenv in .direnv so we don't rebuild every time.
  if [ ! -x .direnv/devenv/bin/devenv ]; then
    echo "direnv: devenv not found; bootstrapping via nixpkgs#devenv..." >&2
    out="$(nix build --no-link --print-out-paths nixpkgs#devenv)"
    ln -sfn "$out" .direnv/devenv
  fi

  PATH_add ".direnv/devenv/bin"
fi

# Now devenv exists, so this works reliably.
eval "$(devenv direnvrc)"
use devenv
